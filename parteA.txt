Def Server(ServerIp,ServerPort) :

    clientsList = [(clientIp,clientPort,clientReady)]


    master = socket.TCP();
    master.bind(ServerIp,ServerPort);
    server = master.Listen();
    server.settimeout(0); 

   
    sktUDP = socket.UDP();
    sktUDP.bind(localhost,65535);

    Thread.new(sendData,sktUDP,clientsList);

    while (true):
            client,err = server.accept();
            if (err != "timeout"):
                Thread.new(clientConection,client,clientsList);
            endIf
    endWhile
    master.close();
EndDef


Def sendData(sktUDP,clientList):
    while (true):
        datagram,ip,port = sktUDP.receive();
            if (datagram != nil):
                for c in clientsList:
                    if (c.getReady())
                        sktUDP.sendTo(datagram,c.clientIp,c.clientPort);
                    endIf
                endFor
            endIf
    endWhile
endDef


Def clientConection(client,clientList):
    clientIp,_ = client.getPeer();
    while (true):
        data = "";
        repeat
            buffer,err = client.receive();
            if (err):
                client.close();
            data += buffer;
        until (buffer == "")    

        if (data.find("CONECTAR")):
            initPos = String.pos(data,"CONECTAR")+1;
            endPos = String.pos(data, "\n");
            clientPort = String.sub(data,initPos,endPos);
            if (!clientsList.find(clientIp,_,_)): 
                clientList.add((clientIp,clientsPort,true));
            endIf
        endif

        if (data.find("DESCONECTAR")): 
            if (clientsList.find(clientIp,_,_)):
                clientList.remove((clientIp,_,_));
            endIf

            message = "OK\n"
            repeat
                remain, err = client.send(message);
                message = remain;
            until (message = "")

            client.close();
            break;
        endIf    

        if data.find("INTERRUMPIR"): //LO PONGO EN FALSE EN LA LISTA PARA QUE NO TRANSMITA
            if (clientsList.find(clientIp,_,_)):
               clientList.modify((clientIp,_,false));
            endIf
        endIf

        if data.find("CONTINUAR"): //LO PONGO EN TRUE EN LA LISTA PARA QUE TRANSMITA
            if (clientsList.find(clientIp,_)):
                clientList.modify((clientIp,_,true));
            endIf
        endIf

        if ((data.find("CONTINUAR") || data.find("DESCONECTAR") || data.find("INTERRUMPIR") || data.find("CONECTAR"))):
            message = "OK\n"
            repeat
                remain, err = client.send(message);
                message = remain;
            until (message = "")
        endIf

    endWhile
endDef;

------------------------------------------------------------------------------------------------------------------------------

Def Client(serverIP,serverPort,vlcPort):
    buff = "";

 
    master = socket.TCP();
    master.bind(localhost,0);

    
    sktUDP = socket.UDP()


    client, err = master.connect(serverIP, serverPort);
    if (err):
        master.close();
        break;
    endIf

    while (true):
        data = IO.readLn();
        if (data.find("CONECTAR")):
            initPos = String.pos(data,"CONECTAR")+1;
            endPos = String.pos(data, "\n");
            clientPort = String.cut(data,initPos,endPos);
            sktUDP.bind(localhost,clientPort);
            Thread.new(transmissionVLC, sktUDP,vlcPort);
        endif

        if (data.find("DESCONECTAR")):
            sktUDP.close();
            break;
        endif
        repeat
            remain,err = client.send(data)
            if (err):
                break;
                client.close();
            endIf
            data = remain
        until (data = "")
    
        if data.find("DESCONECTAR") || data.find("CONECTAR") || data.find("INTERRUMPIR") || data.find("CONTINUAR"):
            repeat
                data, err = client.receive();
                buff += data;
            until (data = "")
            if (!data.find("OK"))
                break;
            endIf
        endif
    endWhile
endDef


Def transmissionVLC(sktUDP,vlcPort):
    
    while (true):
        data,err = sktUDP.receive();
        if (err):
            sktUDP.close();
            break;
        endif
        sktUDP.sendTo(data,localhost,vlcPort);
    endWhile
endDef