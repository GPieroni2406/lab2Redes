Def Server(ServerIp,ServerPort) :
    //CREO LISTA DE CLEINTES
    clientsList = [(clientIp,clientPort,clientReady)]

    //CREO SOCKET TCP
    master = socket.TCP();
    master.bind(ServerIp,ServerPort);
    server = master.Listen();
    server.settimeout(0); //NO BLOQUEANTE

    //CREO SOCKET UDP
    sktUDP = socket.UDP();
    sktUDP.bind(127.0.0.1,65535);


    while (true)
            client,err = server.accept();
            if (err != "timeout"):
                Thread.new(clientConection,client,clientsList);
            endIf

            datagram,ip,port = sktUDP.receive();
            if (datagram != nil):
                for c in clientsList:
                    if (c.getReady())
                        sktUDP.sendTo(datagram,c.clientIp,c.clientPort);
                    endIf
                endFor
            endIf
    endWhile
    master.close();
EndDef


Def clientConection(client,clientList):
    clientIp,_ = client.getPeer();
    while (true):
        data = "";
        repeat
            buffer,err = client.receive();
            if (err):
                client.close();
            data += buffer
        until (buffer == "")    

        if (data.find("CONECTAR")):
            initPos = String.pos(data,"CONECTAR")+1;
            endPos = String.pos(data, "\n");
            clientPort = String.cut(data,initPos,endPos);
            if (!clientsList.find(clientIp,_,_)): //SI EL IP YA ESTA EN LA LISTA NO LO AGREGO
                clientList.add((clientIp,clientsPort,true));
            endIf
        endif

        if (data.find("DESCONECTAR")): //LO SACO DE LA LISTA Y CORTO LA CONEXION TCP
            if (clientsList.find(clientIp,_,_)):
                clientList.remove((clientIp,_,_));
            endIf

            message = "OK\n"
            repeat
                remain, err = client.send(message);
                message = remain;
            until (message = "")

            client.close();
            break;
        endIf    

        if data.find("INTERRUMPIR"): //LO PONGO EN FALSE EN LA LISTA PARA QUE NO TRANSMITA
            if (clientsList.find(clientIp,_,_)):
               clientList.modify((clientIp,_,false));
            endIf
        endIf

        if data.find("CONTINUAR"): //LO PONGO EN TRUE EN LA LISTA PARA QUE TRANSMITA
            if (clientsList.find(clientIp,_)):
                clientList.modify((clientIp,_,true));
            endIf
        endIf

        if ((data.find("CONTINUAR") || data.find("DESCONECTAR") || data.find("INTERRUMPIR") || data.find("CONECTAR"))):
            message = "OK\n"
            repeat
                remain, err = client.send(message);
                message = remain;
            until (message = "")
        endIf

    endWhile
endDef;



Def Client(serverIP,serverPort,vlcPort):
    buff = "";

    //SOCKET TCP
    master = socket.TCP();
    master.bind(localhost,0);

    //SOCKET UDP
    sktUDP = socket.UDP()

    //SOCKET UDP PARA ENVIAR AL VLC
    sktVLC = socket.UDP();
    skt.bind(localhost,vlcPort);

    client, err = master.connect(serverIP, serverPort);
    if (err):
        master.close();
        break;
    endIf

    while (true):
        data = IO.readLn();
        if (data.find("CONECTAR")):
            initPos = String.pos(data,"CONECTAR")+1;
            endPos = String.pos(data, "\n");
            clientPort = String.cut(data,initPos,endPos);
            sktUDP.bind(localhost,clientPort);
            Thread(sktUDP,sktVLC,clientList);
        endif

        if (data.find("DESCONECTAR")):
            sktVLC.close();
            sktUDP.close();
            break;
        endif
        repeat
            remain,err = client.send(data)
            if (err):
                break;
                client.close();
            endIf
            data = remain
        until (data = "")
    
        if data.find("DESCONECTAR") || data.find("CONECTAR") || data.find("INTERRUMPIR") || data.find("CONTINUAR"):
            repeat
                data, err = client.receive();
                buff += data;
            until (data = "")
            if (!data.find("OK"))
                break;
            endIf
        endif
    endWhile
endDef


Def transmissionVLC(sktUDP,sktVLC):
    clientIp,clientPort = sktVLC.getHost();
    while (true):
        data,err = sktUDP.receive();
        if (err):
            sktUDP.close();
            sktVLC.close();
            break;
        endif
        sktVLC.sendTo(data,localhost,clientPort);
    endWhile
endDef